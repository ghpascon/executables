{% extends "base.html" %} {% block content %}
<div class="container mx-auto px-4 py-8" x-data="logsPage()">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-bold text-gray-900">
        <i class="fas fa-file-text mr-3 text-blue-600"></i>
        System Logs
      </h1>

      <!-- Controls -->
      <div class="flex items-center space-x-4">
        <button
          @click="refreshLogs()"
          class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md"
        >
          <i class="fas fa-sync-alt mr-2"></i>
          Refresh
        </button>
        <div class="flex items-center">
          <span
            class="inline-block w-3 h-3 bg-green-500 rounded-full mr-2"
            :class="{'animate-pulse': autoRefresh}"
          ></span>
          <span class="text-sm text-gray-600">Auto: 20s</span>
        </div>
        <button
          @click="toggleAutoRefresh()"
          :class="autoRefresh ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'"
          class="px-3 py-1 text-white text-sm rounded-md"
        >
          <span x-text="autoRefresh ? 'Stop' : 'Start'"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Search & Filters -->
  <div class="mb-4">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- Search -->
      <div class="md:col-span-3">
        <div class="relative">
          <input
            type="text"
            x-model="searchTerm"
            placeholder="Search logs..."
            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
          />
          <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        </div>
      </div>

      <!-- Level Filter -->
      <div>
        <select
          x-model="selectedLevel"
          class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500"
        >
          <option value="">All Levels</option>
          <option value="ERROR">Error</option>
          <option value="WARNING">Warning</option>
          <option value="INFO">Info</option>
          <option value="DEBUG">Debug</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Logs Content -->
  <div class="bg-white rounded-lg shadow border overflow-hidden">
    <!-- Header -->
    <div class="bg-gray-50 border-b px-4 py-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Recent Logs</h2>
        <div class="text-sm text-gray-600">
          <span x-text="filteredLogs.length"></span> lines
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div class="h-96 overflow-y-auto bg-black text-green-400 font-mono text-sm">
      <!-- Loading -->
      <div
        x-show="logs.length === 0"
        class="flex items-center justify-center h-full"
      >
        <div class="text-center text-gray-500">
          <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
          <p>Loading logs...</p>
        </div>
      </div>

      <!-- Logs List -->
      <div x-show="logs.length > 0" class="p-4">
        <template x-for="(line, index) in filteredLogs" :key="index">
          <div
            class="mb-1 hover:bg-gray-800 px-2 py-1 rounded"
            :class="getLineClass(line)"
          >
            <span
              class="text-gray-500 mr-3 text-xs"
              x-text="String(index + 1).padStart(4, '0')"
            ></span>
            <span x-html="formatLogLine(line)"></span>
          </div>
        </template>
      </div>

      <!-- No Results -->
      <div
        x-show="filteredLogs.length === 0 && logs.length > 0"
        class="flex items-center justify-center h-full"
      >
        <div class="text-center text-gray-500">
          <i class="fas fa-search text-2xl mb-4"></i>
          <p>No logs match your search</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="mt-4 text-center">
    <p class="text-sm text-gray-500">
      Last update: <span x-text="lastUpdate"></span>
    </p>
  </div>
</div>

<script>
  function logsPage() {
    return {
      autoRefresh: true,
      searchTerm: "",
      selectedLevel: "",
      lastUpdate: "Never",
      refreshInterval: null,
      logs: [],

      init() {
        this.loadLogs();
        this.startAutoRefresh();
      },

      async loadLogs() {
        try {
          const response = await fetch("/logs/get_content");
          if (response.ok) {
            const data = await response.json();
            this.logs = data.content.slice().reverse();
            this.updateTimestamp();
          } else {
            this.logs = [`Error: Failed to load logs (${response.status})`];
          }
        } catch (error) {
          this.logs = [`Error: ${error.message}`];
        }
      },

      get filteredLogs() {
        let filtered = this.logs;

        // Filter by search term
        if (this.searchTerm) {
          const search = this.searchTerm.toLowerCase();
          filtered = filtered.filter((line) =>
            line.toLowerCase().includes(search)
          );
        }

        // Filter by level
        if (this.selectedLevel) {
          filtered = filtered.filter((line) =>
            line.includes(this.selectedLevel)
          );
        }

        return filtered;
      },

      getLineClass(line) {
        if (line.includes("ERROR")) return "text-red-400";
        if (line.includes("WARNING")) return "text-yellow-400";
        if (line.includes("INFO")) return "text-blue-400";
        if (line.includes("DEBUG")) return "text-gray-400";
        return "text-green-400";
      },

      startAutoRefresh() {
        if (this.refreshInterval) clearInterval(this.refreshInterval);
        this.refreshInterval = setInterval(() => {
          if (this.autoRefresh) this.loadLogs();
        }, 20000);
      },

      toggleAutoRefresh() {
        this.autoRefresh = !this.autoRefresh;
      },

      async refreshLogs() {
        await this.loadLogs();
      },

      updateTimestamp() {
        this.lastUpdate = new Date().toLocaleTimeString("en-US", {
          hour12: false,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      },

      formatLogLine(line) {
        // Decode HTML entities and preserve formatting
        const textarea = document.createElement("textarea");
        textarea.innerHTML = line;
        return textarea.value;
      },
    };
  }
</script>
{% endblock %}
