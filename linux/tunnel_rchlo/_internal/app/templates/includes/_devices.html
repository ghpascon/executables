<!-- Devices Widget Simplificado -->
<div
  class="bg-white rounded-lg shadow-lg border p-4 flex flex-col w-full max-h-[70vh]"
  x-data="devicesSummary()"
>
  <!-- Header -->
  <div class="text-sm mb-4 flex-shrink-0">
    <h4 class="font-semibold text-gray-800 mb-3 text-center">Device Status</h4>

    <!-- Status Vertical -->
    <div class="space-y-2">
      <div class="flex justify-between">
        <span class="text-gray-500">Total</span>
        <span class="font-medium text-gray-800" x-text="stats.total"></span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-500">Connected</span>
        <span
          class="font-medium text-green-600"
          x-text="stats.connected"
        ></span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-500">Reading</span>
        <span class="font-medium text-blue-600" x-text="stats.reading"></span>
      </div>
    </div>
  </div>

  <!-- Divider -->
  <div class="border-t border-gray-300 my-4 flex-shrink-0"></div>

  <!-- Control All Buttons -->
  <div class="flex gap-2 mb-4 flex-shrink-0">
    <button
      @click="startInventoryAll()"
      :disabled="stats.connected === 0"
      :class="{
        'bg-green-500 hover:bg-green-600': stats.connected > 0,
        'bg-gray-300 cursor-not-allowed': stats.connected === 0
      }"
      class="flex-1 px-2 py-1 text-white text-xs rounded font-medium transition-colors"
    >
      Start All
    </button>
    <button
      @click="stopInventoryAll()"
      class="flex-1 px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded font-medium transition-colors"
    >
      Stop All
    </button>
  </div>

  <!-- Device List -->
  <div class="space-y-2 overflow-y-auto flex-1" style="min-height: 0">
    <template x-for="device in devices" :key="device.name">
      <div
        class="flex items-center gap-3 p-2 bg-gray-50 rounded text-sm hover:bg-gray-100 transition-colors"
      >
        <span
          class="font-medium text-gray-800 truncate flex-1"
          x-text="device.name"
        ></span>

        <div
          class="w-3 h-3 rounded-full flex-shrink-0"
          :class="
            !device.is_connected ? 'bg-red-500' :
            (device.is_connected && device.can_print) ? 'bg-green-500' :
            (device.is_connected && device.is_reading) ? 'bg-green-500 pulse-fast' :
            'bg-yellow-500'"
        ></div>
        <template x-if="device.device_type === 'printer'">
          <span
            class="ml-2 text-xs font-semibold text-gray-700"
            x-text="device.to_print"
          ></span>
        </template>

        <!-- RFID Control Button -->
        <template x-if="device.device_type === 'rfid'">
          <button
            @click="toggleInventory(device)"
            :disabled="!device.is_connected || device.is_gpi_trigger_on"
            :class="{
              'bg-green-500 hover:bg-green-600': device.is_connected && !device.is_reading && !device.is_gpi_trigger_on,
              'bg-red-500 hover:bg-red-600': device.is_connected && device.is_reading && !device.is_gpi_trigger_on,
              'bg-gray-300 cursor-not-allowed': !device.is_connected || device.is_gpi_trigger_on
            }"
            class="px-3 py-1 text-white text-xs rounded font-medium min-w-[50px] transition-colors"
            x-text="device.is_gpi_trigger_on ? 'GPI' : (!device.is_connected ? 'Off' : (device.is_reading ? 'Stop' : 'Start'))"
          ></button>
        </template>
      </div>
    </template>

    <!-- Empty State -->
    <div x-show="devices.length === 0" class="text-center py-8 text-gray-400">
      <div class="text-4xl mb-2">ðŸ“±</div>
      <div class="text-sm">No devices found</div>
    </div>
  </div>
</div>

<style>
  .pulse-fast {
    animation: pulse-fast 0.8s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  @keyframes pulse-fast {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.3;
    }
  }
</style>

<script>
  function devicesSummary() {
    return {
      devices: [],
      stats: { total: 0, connected: 0, reading: 0 },

      async init() {
        await this.loadDevices();
        setInterval(() => this.loadDevices(), 1000);
      },

      async loadDevices() {
        try {
          const response = await fetch("{{ url_for('get_devices_info') }}");
          if (response.ok) {
            const data = await response.json();
            this.devices = Array.isArray(data) ? data : [];
            this.updateStats();
          }
        } catch (err) {
          console.error("Error loading devices:", err);
        }
      },

      updateStats() {
        this.stats.total = this.devices.length;
        this.stats.connected = this.devices.filter(
          (d) => d.is_connected,
        ).length;
        this.stats.reading = this.devices.filter((d) => d.is_reading).length;
      },

      async toggleInventory(device) {
        if (!device.is_connected) return;

        const endpoint = device.is_reading
          ? "{{ url_for('stop_device_inventory', device_name='DEVICE_NAME') }}".replace(
              "DEVICE_NAME",
              device.name,
            )
          : "{{ url_for('start_device_inventory', device_name='DEVICE_NAME') }}".replace(
              "DEVICE_NAME",
              device.name,
            );

        try {
          const response = await fetch(endpoint, { method: "POST" });
          if (response.ok) {
            // Reload devices immediately after action
            await this.loadDevices();
          } else {
            console.error("Failed to toggle inventory:", await response.json());
          }
        } catch (err) {
          console.error("Error toggling inventory:", err);
        }
      },

      async startInventoryAll() {
        try {
          const response = await fetch("{{ url_for('start_inventory_all') }}", {
            method: "POST",
          });
          if (response.ok) {
            await this.loadDevices();
          } else {
            console.error("Failed to start all:", await response.json());
          }
        } catch (err) {
          console.error("Error starting all:", err);
        }
      },

      async stopInventoryAll() {
        try {
          const response = await fetch("{{ url_for('stop_inventory_all') }}", {
            method: "POST",
          });
          if (response.ok) {
            await this.loadDevices();
          } else {
            console.error("Failed to stop all:", await response.json());
          }
        } catch (err) {
          console.error("Error stopping all:", err);
        }
      },
    };
  }
</script>
