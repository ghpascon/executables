<div x-data="applicationSettings()" x-init="init()">
  <div class="bg-white rounded-2xl shadow-lg p-6">
    <div class="mb-4">
      <h2 class="text-xl font-bold text-gray-900 mb-1">
        Application Configuration
      </h2>
      <p class="text-sm text-gray-600">
        Configure general application settings and behavior
      </p>
    </div>

    <!-- Loading State -->
    <div x-show="loading" class="flex justify-center items-center py-8">
      <div
        class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"
      ></div>
    </div>

    <!-- Settings Form grouped by type -->
    <form x-show="!loading" @submit.prevent="saveSettings()" x-cloak>
      <div class="space-y-4">
        <!-- Booleans -->
        <div x-show="groups.bools.length > 0">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Toggles</h3>
          <div class="grid grid-cols-1 gap-3">
            <template x-for="key in groups.bools" :key="key">
              <div
                class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"
              >
                <div
                  class="text-sm font-medium text-gray-700"
                  x-text="formatLabel(key)"
                ></div>
                <div class="flex items-center space-x-2">
                  <button
                    type="button"
                    @click="applyExample(key)"
                    x-show="examples[key] !== undefined"
                    class="text-xs text-purple-600 hover:text-purple-700 font-medium"
                    title="Use example value"
                  >
                    Example
                  </button>
                  <button
                    type="button"
                    @click="settings[key] = !settings[key]"
                    :class="settings[key] ? 'bg-blue-600' : 'bg-gray-300'"
                    class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                  >
                    <span
                      :class="settings[key] ? 'translate-x-4' : 'translate-x-0'"
                      class="pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                    ></span>
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Numbers -->
        <div x-show="groups.numbers.length > 0">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Numbers</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <template x-for="key in groups.numbers" :key="key">
              <div>
                <label
                  class="block text-xs font-medium text-gray-700 mb-1"
                  x-text="formatLabel(key)"
                ></label>
                <div class="flex space-x-2">
                  <input
                    type="number"
                    x-model.number="settings[key]"
                    class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  />
                  <button
                    type="button"
                    @click="applyExample(key)"
                    x-show="examples[key] !== undefined"
                    class="px-3 py-2 text-xs bg-purple-50 text-purple-600 hover:bg-purple-100 rounded-lg transition-colors font-medium"
                  >
                    Ex
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Strings -->
        <div x-show="groups.strings.length > 0">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Text</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <template x-for="key in groups.strings" :key="key">
              <div>
                <label
                  class="block text-xs font-medium text-gray-700 mb-1"
                  x-text="formatLabel(key)"
                ></label>
                <div class="flex space-x-2">
                  <input
                    type="text"
                    x-model="settings[key]"
                    class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  />
                  <button
                    type="button"
                    @click="applyExample(key)"
                    x-show="examples[key] !== undefined && examples[key] !== null && examples[key] !== ''"
                    class="px-3 py-2 text-xs bg-purple-50 text-purple-600 hover:bg-purple-100 rounded-lg transition-colors font-medium"
                  >
                    Ex
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Others -->
        <div x-show="groups.others.length > 0">
          <h3 class="text-sm font-medium text-gray-700 mb-2">Other</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <template x-for="key in groups.others" :key="key">
              <div>
                <label
                  class="block text-xs font-medium text-gray-700 mb-1"
                  x-text="formatLabel(key)"
                ></label>
                <div class="flex space-x-2">
                  <input
                    type="text"
                    x-model="settings[key]"
                    class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  />
                  <button
                    type="button"
                    @click="applyExample(key)"
                    x-show="examples[key] !== undefined && examples[key] !== null && examples[key] !== ''"
                    class="px-3 py-2 text-xs bg-purple-50 text-purple-600 hover:bg-purple-100 rounded-lg transition-colors font-medium"
                  >
                    Ex
                  </button>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-between items-center mt-6 pt-4 border-t">
        <button
          type="button"
          @click="loadExamples(true)"
          class="px-4 py-2 text-sm bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors"
          title="Load all example values"
        >
          Load All Examples
        </button>
        <div class="flex space-x-3">
          <button
            type="button"
            @click="loadSettings()"
            class="px-4 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
          >
            Reset
          </button>
          <button
            type="submit"
            :disabled="saving"
            class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            <span x-show="!saving">Save Settings</span>
            <span x-show="saving">Saving...</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  function applicationSettings() {
    return {
      settings: {},
      examples: {},
      loading: false,
      saving: false,
      groups: { bools: [], numbers: [], strings: [], others: [] },

      async init() {
        await this.loadSettings();
        await this.loadExamples();
      },

      buildGroups() {
        const g = { bools: [], numbers: [], strings: [], others: [] };
        const keys = new Set([
          ...Object.keys(this.settings || {}),
          ...Object.keys(this.examples || {}),
        ]);
        for (const k of keys) {
          const v = this.settings ? this.settings[k] : undefined;
          const ex = this.examples ? this.examples[k] : undefined;
          let t = null;
          if (v !== null && v !== undefined) t = typeof v;
          else if (ex !== null && ex !== undefined) t = typeof ex;

          if (t === "boolean") g.bools.push(k);
          else if (t === "number") g.numbers.push(k);
          else if (t === "string") g.strings.push(k);
          else g.others.push(k);
        }
        this.groups = g;
      },

      applyExample(key) {
        if (this.examples && this.examples[key] !== undefined) {
          this.settings[key] = this.examples[key];
        }
      },

      async loadSettings() {
        this.loading = true;
        try {
          const response = await fetch('{{ url_for("get_current_settings") }}');
          const data = await response.json();
          this.settings = data || {};
          this.buildGroups();
        } catch (error) {
          showAlert("Error loading settings", "error", 5000);
          console.error("Error loading settings:", error);
        } finally {
          this.loading = false;
        }
      },

      async loadExamples(applyToSettings = false) {
        try {
          const response = await fetch(
            '{{ url_for("get_application_config_example") }}',
          );
          const data = await response.json();
          this.examples = data || {};

          if (applyToSettings) {
            this.settings = { ...this.settings, ...this.examples };
            showAlert("Example values loaded", "success", 3000);
          }

          // Rebuild groups after examples are available so types can be inferred from examples
          this.buildGroups();
        } catch (error) {
          console.error("Error loading examples:", error);
        }
      },

      async saveSettings() {
        this.saving = true;
        try {
          const response = await fetch('{{ url_for("update_settings") }}', {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(this.settings),
          });

          if (response.ok) {
            const data = await response.json();
            showAlert("Settings updated successfully", "success", 5000);
            this.settings = data.settings || this.settings;
            this.buildGroups();
          } else {
            showAlert("Error updating settings", "error", 5000);
          }
        } catch (error) {
          showAlert("Error updating settings", "error", 5000);
          console.error("Error updating settings:", error);
        } finally {
          this.saving = false;
        }
      },

      formatLabel(key) {
        return key
          .split("_")
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      },
    };
  }
</script>
